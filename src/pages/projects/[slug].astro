---
import katex from "katex";
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { siteConfig } from '../../config';

import '../../styles/global.css';

export async function getStaticPaths() {
  const modules = import.meta.glob('../../contents/*.{md,mdx}', { eager: true });
  return Object.keys(modules).map((path) => {
    const slug = path.split('/').pop().replace(/\.mdx?$/, '').replace(/\.md$/, '');
    return { params: { slug } };
  });
}

const modules = import.meta.glob('../../contents/*.{md,mdx}', { eager: true });

const all = Object.fromEntries(
  Object.entries(modules).map(([path, mod]) => {
    const slug = path.split('/').pop().replace(/\.mdx?$/, '').replace(/\.md$/, '');
    return [slug, mod];
  })
);

const { slug } = Astro.params;
const project = all[slug];

if (!project) {
  throw new Error(`Project "${slug}" not found. Ensure src/contents/${slug}.md exists.`);
}

const ProjectContent = project.default;
const meta = project.frontmatter ?? {};

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function renderMathInText(text) {
  if (!text) return "";
  const escaped = escapeHtml(text);
  return escaped.replace(/\$(.+?)\$/g, (match, mathContent) => {
    try {
      return katex.renderToString(mathContent, { throwOnError: false });
    } catch (e) {
      return match;
    }
  });
}

const titleHtml = renderMathInText(meta.title ?? slug);
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{meta.title ?? slug} â€” {Astro.site?.title}</title>
    <meta name="description" content={meta.summary ?? meta.description ?? Astro.site?.description ?? ''} />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <script>
      (function(){
        try {
          const stored = localStorage.getItem('theme');
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          const theme = stored || (prefersDark ? 'dark' : 'light');
          if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            document.documentElement.setAttribute('data-theme','dark');
          } else {
            document.documentElement.classList.remove('dark');
            document.documentElement.setAttribute('data-theme','light');
          }
        } catch(e){}
      })();
    </script>
    <style>
    :root { --project-text: rgba(var(--text-color), 1); --project-muted: rgba(var(--muted-text-color), 1); }
    
    .project-header h1 {
      font-weight: 400 !important;
    }

    .project-prose {
      font-family: var(--body-font);
      color: var(--project-text);
      line-height: 1.8;
      font-size: 1.03rem;
    }

    .project-prose p {
      margin-top: 0.9rem;
      margin-bottom: 1.05rem;
      font-size: 1.02rem;
      letter-spacing: 0.0015em;
      color: var(--project-text);
      font-family: var(--body-font);
      font-weight: 400;
    }

    .project-prose .prose h1,
    .project-prose h1 {
      font-size: 1.9rem;
      margin-top: 1.6rem;
      margin-bottom: 0.6rem;
      line-height: 1.12;
      font-weight: 600;
      color: rgba(var(--text-color), 1);
      font-family: var(--heading-font);
      text-align: left;
    }
    
    .project-prose .prose h2,
    .project-prose h2 {
      font-size: 1.125rem;
      margin-top: 1.2rem;
      margin-bottom: 0.6rem;
      line-height: 1.15;
      font-weight: 600;
      color: rgba(var(--text-color), 1);
      font-family: var(--heading-font);
      text-align: left;
    }

    .project-prose ul, .project-prose ol {
      padding-left: 1.25rem;
      margin-top: 0.6rem;
      margin-bottom: 0.9rem;
      color: var(--project-text);
    }

    .project-prose pre {
      background: rgba(11,18,32,0.86);
      color: #e6eef8;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.95rem;
    }
    .project-prose code {
      font-family: var(--mono-font);
      background: rgba(15,23,42,0.06);
      padding: 0.12rem 0.3rem;
      border-radius: 4px;
      color: rgba(var(--text-color), 0.95);
    }

    .project-prose .katex { font-size: 1.02rem; line-height: 1.35; }
    .project-prose .katex-display { margin: 1rem 0; }

    .skill-pill {
      display:inline-block;
      font-family: var(--body-font);
      padding: 0.25rem 0.6rem;
      border-radius: 0.5rem;
      background: rgba(var(--card-bg-rgb), 0.92);
      color: rgba(var(--text-color), 1);
      font-size: 0.75rem;
      margin-right:0.35rem;
      margin-top:0.3rem;
      font-weight: 600;
    }

    a.cite {
      color: rgba(var(--muted-text-color), 1);
      text-decoration: none;
      padding: 0 .18rem;
      border-radius: 6px;
      transition: background-color .18s ease, color .18s ease, transform .12s ease;
      display: inline-block;
      line-height: 1;
      vertical-align: baseline;
      font-weight: 500;
    }

    a.cite:hover,
    a.cite:focus {
      background: rgba(var(--accent-rgb), 0.08);
      color: var(--accent-color);
      transform: translateY(-1px);
      outline: none;
    }

    a.cite.cite-active {
      background: rgba(var(--accent-rgb), 0.12);
      color: var(--accent-color);
      box-shadow: 0 6px 20px rgba(2,6,23,0.12);
    }

    a.cite:focus-visible { box-shadow: 0 0 0 4px rgba(var(--accent-rgb),0.12); border-radius: 4px; }

    .ref-panel {
      position: absolute;
      left: 0;
      top: 0;
      width: 360px;
      max-width: 48vw;
      max-height: 60vh;
      overflow-y: auto;
      padding: 1rem;
      background: rgba(var(--card-bg-rgb), 0.78);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(var(--muted-text-color), 0.08);
      box-shadow: 0 12px 40px rgba(2,6,23,0.12);
      font-family: var(--mono-font);
      font-size: 0.95rem;
      display: none;
      z-index: 9999;
      border-radius: 10px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .22s ease, transform .22s ease;
    }

    .ref-panel.open {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .ref-panel h4 { font-weight: 600; margin-bottom: .45rem; color: rgba(var(--text-color),1); }
    .ref-entry { margin-bottom: .9rem; color: rgba(var(--text-color),0.95); }

    @media (max-width: 1024px) {
      .ref-panel { position: fixed; left: 8px; right: 8px; top: 12vh; max-width: calc(100% - 16px); width: auto; }
    }
    </style>
  </head>

  <script>
    (function normalizeReferenceLinks(){
      function convert() {
        const anchors = document.querySelectorAll('.project-prose a[href^="#ref-"]');
        anchors.forEach(a => {
          try {
            const href = a.getAttribute('href');
            const id = href.replace(/^#/, '');
            a.classList.add('cite');
            a.setAttribute('data-ref', id.replace(/^ref-/, ''));
            a.setAttribute('role', 'button');
            a.setAttribute('tabindex', '0');
          } catch(e){}
        });
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', convert);
      } else convert();
    })();
  </script>

  <style>
    #refContent { text-align: left; max-width: 65ch; margin: 2rem auto; }
  </style>

  <body class="bg-white text-gray-900 font-mono">
    <Header />

    <main class="max-w-4xl mx-auto px-6 md:px-8 lg:px-12 py-10 pt-28">
      
      <header class="project-header mb-6">
        <h1 class="text-3xl md:text-4xl leading-tight font-normal" set:html={titleHtml}></h1>
        {meta.skills && meta.skills.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-3">
            {meta.skills.map(s => (
              <span class="px-2.5 sm:px-3 py-1 sm:py-1.5 bg-gray-900 text-white rounded-md sm:rounded-lg text-xs sm:text-sm font-medium">
                {s}
              </span>
            ))}
          </div>
        )}
      </header>

      {(meta.banner ?? (`/projects/${slug}.jpg`)) ? (
        <div class="project-banner my-6">
          <img
            src={meta.banner ?? `/projects/${slug}.jpg`}
            alt={`${meta.title ?? slug} banner`}
            class="w-full rounded-lg object-cover max-h-[420px]"
            onerror="this.src='/projects/temp.jpg'"
            loading="lazy"
          />
        </div>
      ) : null}

      <article class="project-prose">
        <article class="prose prose-lg lg:prose-xl max-w-none mx-auto dark:prose-invert"><ProjectContent /></article>
      </article>
    </main>

  <aside id="refPanel" class="ref-panel" aria-hidden="true">
    <h4>Reference</h4>
    <div id="refContent"></div>
  </aside>
  
  <script>
  (function(){
    const refPanel = document.getElementById('refPanel');
    const refContent = document.getElementById('refContent');
    let hoverTimer = null;
    let activeCite = null;

    function showPanelForElement(el, htmlContent) {
      if (!el || !refPanel) return;
      refContent.innerHTML = htmlContent;

      refPanel.classList.add('open');
      refPanel.setAttribute('aria-hidden', 'false');

      const rect = el.getBoundingClientRect();
      const scrollX = window.scrollX || window.pageXOffset;
      const scrollY = window.scrollY || window.pageYOffset;

      const viewportWidth = document.documentElement.clientWidth;
      const viewportHeight = document.documentElement.clientHeight;

      let left = rect.right + 12 + scrollX;
      let top = rect.top + scrollY;

      const panelWidth = refPanel.offsetWidth || 320;
      const panelHeight = refPanel.offsetHeight || Math.round(viewportHeight * 0.5);

      if (left + panelWidth > viewportWidth - 12 + scrollX) {
        left = rect.left - panelWidth - 12 + scrollX;
      }
      if (left < 12 + scrollX) left = 12 + scrollX;

      if (top + panelHeight > scrollY + viewportHeight - 12) {
        top = Math.max(scrollY + 12, (scrollY + viewportHeight) - panelHeight - 12);
      }
      if (top < scrollY + 12) top = scrollY + 12;

      refPanel.style.left = `${left}px`;
      refPanel.style.top = `${top}px`;
    }

    document.addEventListener('pointerenter', (e) => {
      const el = e.target.closest && e.target.closest('a.cite[data-ref]');
      if (!el) return;
      clearTimeout(hoverTimer);
      const id = el.getAttribute('data-ref');
      const def = document.getElementById('ref-' + id);
      if (!def) return;
      const defInner = def.querySelector('.ref-entry') || def;
      if (activeCite && activeCite !== el) activeCite.classList.remove('cite-active');
      el.classList.add('cite-active');
      activeCite = el;
      showPanelForElement(el, defInner.innerHTML);
    }, true);

    document.addEventListener('pointerleave', (e) => {
      const el = e.target.closest && e.target.closest('a.cite[data-ref]');
      if (!el) return;
      hoverTimer = setTimeout(() => {
        if (el.classList.contains('cite-active')) el.classList.remove('cite-active');
        if (refPanel) {
          refPanel.classList.remove('open');
          refPanel.setAttribute('aria-hidden', 'true');
        }
        activeCite = null;
      }, 250);
    }, true);

    if (refPanel) {
      refPanel.addEventListener('pointerenter', () => clearTimeout(hoverTimer));
      refPanel.addEventListener('pointerleave', () => {
        hoverTimer = setTimeout(() => {
          if (activeCite) activeCite.classList.remove('cite-active');
          if (refPanel) {
            refPanel.classList.remove('open');
            refPanel.setAttribute('aria-hidden', 'true');
          }
          activeCite = null;
        }, 200);
      });
    }

    window.addEventListener('scroll', function() {
      if (refPanel && refPanel.classList.contains('open') && activeCite) {
        showPanelForElement(activeCite, refContent.innerHTML);
      }
    }, { passive: true });
    window.addEventListener('resize', function() {
      if (refPanel && refPanel.classList.contains('open') && activeCite) {
        showPanelForElement(activeCite, refContent.innerHTML);
      }
    });

  })();
  </script>

  <script>
  (function(){
    const prefersDarkQuery = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

    function detectTheme() {
      const html = document.documentElement;
      if (html.hasAttribute('data-theme')) return html.getAttribute('data-theme');
      if (html.classList.contains('dark')) return 'dark';
      const ls = localStorage.getItem('theme');
      if (ls) return ls;
      return prefersDarkQuery && prefersDarkQuery.matches ? 'dark' : 'light';
    }

    function updatePictures(theme) {
      document.querySelectorAll('picture').forEach(p => {
        const img = p.querySelector('img');
        if (!img) return;

        const lightSrc = img.getAttribute('data-src-light') || p.getAttribute('data-light');
        const darkSrc  = img.getAttribute('data-src-dark')  || p.getAttribute('data-dark');

        const lightSrcset = img.getAttribute('data-srcset-light') || p.getAttribute('data-srcset-light');
        const darkSrcset  = img.getAttribute('data-srcset-dark')  || p.getAttribute('data-srcset-dark');

        if (theme === 'dark' && darkSrc) {
          if (img.src !== darkSrc) img.src = darkSrc;
          if (darkSrcset) img.setAttribute('srcset', darkSrcset);
        } else if (theme === 'light' && lightSrc) {
          if (img.src !== lightSrc) img.src = lightSrc;
          if (lightSrcset) img.setAttribute('srcset', lightSrcset);
        }
      });
    }

    try { updatePictures(detectTheme()); } catch(e){}

    const mo = new MutationObserver(() => {
      try { updatePictures(detectTheme()); } catch(e){}
    });
    mo.observe(document.documentElement, { attributes: true, attributeFilter: ['class','data-theme'] });

    window.addEventListener('theme-toggle', () => {
      try { updatePictures(detectTheme()); } catch(e){}
    });

    if (prefersDarkQuery && typeof prefersDarkQuery.addEventListener === 'function') {
      prefersDarkQuery.addEventListener('change', (ev) => {
        if (!localStorage.getItem('theme')) {
          updatePictures(ev.matches ? 'dark' : 'light');
        }
      });
    }
  })();
  </script>

  <Footer />
</body>
</html>
